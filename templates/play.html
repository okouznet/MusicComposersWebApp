<!DOCTYPE html>
<html lang="en">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>

<head>
    <meta charset="UTF-8">
    <title>Play</title>
    <link rel="stylesheet" href="/static/playStyles.css"/>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>

    <script type='text/javascript' src='http://midijs.net/lib/midi.js'></script>
    <script src="../static/midi_files/inc/shim/Base64.js" type="text/javascript"></script>
	<script src="../static/midi_files/inc/shim/Base64binary.js" type="text/javascript"></script>
	<script src="../static/midi_files/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <script src="../static/midi_files/inc/shim/WebMIDIAPI.js" type="text/javascript"></script>

    <!-- jasmid package -->
	<script src="../static/midi_files/inc/jasmid/stream.js" type="text/javascript"></script>
	<script src="../static/midi_files/inc/jasmid/midifile.js" type="text/javascript"></script>
	<script src="../static/midi_files/inc/jasmid/replayer.js" type="text/javascript"></script>
	<!-- midi.js package -->
	<script src="../static/midi_files/js/midi/audioDetect.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/midi/gm.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/midi/loader.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/midi/plugin.audiotag.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/midi/plugin.webaudio.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <script src="../static/midi_files/js/midi/player.js" type="text/javascript"></script>
    <script src="../static/midi_files/js/midi/synesthesia.js" type="text/javascript"></script>

	<!-- utils -->
	<script src="../static/midi_files/js/util/dom_request_xhr.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/util/dom_request_script.js" type="text/javascript"></script>
    <script src="../static/midi_files/midi_file.js" type="text/javascript"></script>
    <script src="../static/midi_files/JZZ.Midi.js" type="text/javascript"></script>
    <script src="../static/midi_files/JZZ.MidiFile.js" type="text/javascript"></script>
</head>
<script type="text/javascript">
    //create midi file
    /*
    mf = new JZZ_.MidiFile(1,100);
    //MIDI file tracks
    var tr0 = new JZZ_.MidiFile.MTrk; mf.push(tr0); // First track in Type 1 MIDI file is normally used for tempo changes
    var tr1 = new JZZ_.MidiFile.MTrk; mf.push(tr1); // This one will be for the music

    */
    octave = 4;
    keys = [];
    window.onload = function () {
        keys = {{ whitekeys|tojson }};
        keys.push( {{ blackkeys|tojson }});
        var all_notes = ["C","C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

        document.getElementById('C').addEventListener('click', function(){PlayClickedNote('C')}, false);
        document.getElementById('C#').addEventListener('click', function(){PlayClickedNote('C#')}, false);
        document.getElementById('D').addEventListener('click', function(){PlayClickedNote('D')}, false);
        document.getElementById('D#').addEventListener('click', function(){PlayClickedNote('D#')}, false);
        document.getElementById('E').addEventListener('click', function(){PlayClickedNote('E')}, false);
        document.getElementById('F').addEventListener('click', function(){PlayClickedNote('F')}, false);
        document.getElementById('F#').addEventListener('click', function(){PlayClickedNote('F#')}, false);
        document.getElementById('G').addEventListener('click', function(){PlayClickedNote('G')}, false);
        document.getElementById('G#').addEventListener('click', function(){PlayClickedNote('G#')}, false);
        document.getElementById('A').addEventListener('click', function(){PlayClickedNote('A')}, false);
        document.getElementById('A#').addEventListener('click', function(){PlayClickedNote('A#')}, false);
        document.getElementById('B').addEventListener('click', function(){PlayClickedNote('B')}, false);
        /*
        document.getElementById('C').addEventListener('touchstart', function(){PlayClickedNote('C')}, false);
        document.getElementById('C#').addEventListener('touchstart', function(){PlayClickedNote('C#')}, false);
        document.getElementById('D').addEventListener('touchstart', function(){PlayClickedNote('D')}, false);
        document.getElementById('D#').addEventListener('touchstart', function(){PlayClickedNote('D#')}, false);
        document.getElementById('E').addEventListener('touchstart', function(){PlayClickedNote('E')}, false);
        document.getElementById('F').addEventListener('touchstart', function(){PlayClickedNote('F')}, false);
        document.getElementById('F#').addEventListener('touchstart', function(){PlayClickedNote('F#')}, false);
        document.getElementById('G').addEventListener('touchstart', function(){PlayClickedNote('G')}, false);
        document.getElementById('G#').addEventListener('touchstart', function(){PlayClickedNote('G#')}, false);
        document.getElementById('A').addEventListener('touchstart', function(){PlayClickedNote('A')}, false);
        document.getElementById('A#').addEventListener('touchstart', function(){PlayClickedNote('A#')}, false);
        document.getElementById('B').addEventListener('touchstart', function(){PlayClickedNote('B')}, false);
        */
	    MIDI.loadPlugin({
		    soundfontUrl: "../static/midi_files/examples/soundfont/",
		    instrument: "acoustic_grand_piano",
		    onprogress: function(state, progress) {
			    console.log(state, progress);
		    },
		    onsuccess: function(evt) {
			    console.log(evt);
		    }
	    });
    };
    function PlayNote(note) {
        var delay = 0; // play one note every quarter second
        var velocity = 127; // how hard the note hits
        MIDI.setVolume(0, 127);
        MIDI.chordOn(0, note, velocity, delay);
        MIDI.chordOff(0, note, delay + 0.75);
    }
    function LowOctave() {
        //BUG: sometimes if JS lags, doesn't change octave right away
       if(octave >= 3){
           octave = octave - 1;
       }
       document.getElementById('oct').innerHTML = "Current octave: " + octave;
    }

    function HighOctave() {
       //BUG: sometimes if JS lags, doesn't change octave right away
       if(octave <= 7){
           octave = octave +1;
       }
       document.getElementById('oct').innerHTML = "Current octave: " + octave;
    }

    queue = [];
    play_song = 0;
    function playAlong() {
        play_song = 1;
        queue = {{ music|tojson }};
        queue.shift();
    }
    var id_convert = {90:'C', 83:'C#', 88:'D', 68:'D#', 67:'E', 86:'F', 71:'F#',
        66:'G', 72:'G#', 78:'A', 74:'A#', 77:'B'};
    var id_to_note = {0:'C', 1: 'C#', 2:"D", 3:"D#", 4:"E", 5:"F", 6:"F#",
        7:"G", 8:"G#", 9:"A", 10:"A#", 11:"B"};
    function PlayClickedNote(key) {
        //90:"C-4"
        o = octave + 1; //BUG: OCTAVE
        var map = {
            'C':12*o, //z key - C
            'C#':12*o+1,//s key - C#
            'D':12*o+2,//x key - D
            'D#':12*o+3, //d key - D#
            'E':12*o+4,//c key - E
            'F':12*o+5,//v key - F
            'F#':12*o+6,//g key - F#
            'G':12*o+7,//b key - G
            'G#':12*o+8,//h key - G#
            'A':12*o+9,//n key - A
            'A#':12*o+10, //j key - A#
            'B':12*o+11//m key - B
        };
        var notes = [];
        var x = map[key];
        notes.push(x);
        PlayNote(notes);
    }
    var keys = {};
    var note_modulos = { 90:0, 83:1, 88:2, 68:3, 67:4, 86:5, 71:6,
        66:7, 72:8, 78:9, 74:10, 77:11};
    var note_map = { 90:60, 83:61, 88:62, 68:63, 67:64, 86:65,
        71:66, 66:67, 72:68, 78:69, 74:70, 77:71 };

    document.onkeydown = function (event) {
        if(play_song == 1) {
             var played_notes = {};

            keys[event.which] = true;
            for (var i in keys) {
                played_notes[note_modulos[i]] = true;
            }
            var chord = queue[0]; //peak at tp of queue
            var correct = 0;
            for(var i = 0; i < chord.length; i++) {
                if (chord[i]%12 in played_notes) {
                    correct = 1;
                    break;
                }
            }

            if(correct == 1) {
                for (var i in chord) {
                     var x = chord[i] % 12;
                        var div = document.getElementById(id_to_note[x]);
                        var hasClass = div.classList.contains('whitekey');
                        if (hasClass == true) {
                            document.getElementById(id_to_note[x]).style.background = "white";
                        }
                        else {
                            document.getElementById(id_to_note[x]).style.background = "black";
                        }
                }
                PlayNote(chord);
                queue.shift();
                //highlight next keys
                if(queue.length > 0) {
                    var next_chord = queue[0];
                    for(var i in next_chord) {
                        var x = next_chord[i] % 12;
                        document.getElementById(id_to_note[x]).style.background = "rosybrown";
                    }
                }

            }
        }
        else {
            keys[event.which] = true;
            var notes = [];
            for (var i in keys) {
                notes.push(note_map[i]);
                if(id_convert[i] != null) {
                    document.getElementById(id_convert[i]).style.background = "cornflowerblue";
                }


            }
            PlayNote(notes);
        }
    };
    document.onkeyup = function(event) {
        for (var i in keys) {
          if(id_convert[i] != null) {
              var div = document.getElementById(id_convert[i]);
              var hasClass = div.classList.contains('whitekey');
              if (hasClass == true) {
                  document.getElementById(id_convert[i]).style.background = "white";
              }
              else {
                  document.getElementById(id_convert[i]).style.background = "black";
              }
          }
        }
        delete keys[event.which];
    };
    //event handlers

</script>
<header>
    <div class="header1">
      <a class="header" id="nav_home" href="{{url_for('homepage')}}">Music Composer</a>
        <br>
        <br>
    </div>
</header>
<body>
    <br><br><br>
    <div class = "centerButtons">
         <button>Lower Octave</button>
         <button>Higher Octave</button>
         <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
         <button onclick="playAlong()">Play Along</button><br>

    </div>
    <div class = piano>
    <ul>
        <li class = "key">
            <span class="whitekey" id = "C"></span>
            <span class="blackkey" id = "C#"></span>
        </li>
        <li class = "key">
            <span class="whitekey" id = "D"></span>
            <span class="blackkey" id = "D#"></span>
        </li>
        <li class = "key">
            <span class="whitekey" id = "E"></span>
        </li>
        <li class = "key">
            <span class="whitekey" id = "F"></span>
            <span class="blackkey" id = "F#"></span>
        </li>
        <li class = "key">
            <span class="whitekey" id = "G"></span>
            <span class="blackkey" id = "G#"></span>
        </li>
        <li class = "key">
            <span class="whitekey" id = "A"></span>
            <span class="blackkey" id = "A#"></span>
        </li>
        <li class = "key">
            <span class="whitekey" id = "B"></span>
        </li>

    </ul>
    </div>

</body>
<footer style = "position: fixed; bottom:0px;">
    <p>Brought to you by Nicola, Sasha, Alden and Amit</p>
</footer>
</html>