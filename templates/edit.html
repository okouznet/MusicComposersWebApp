<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit</title>
    <link rel="stylesheet" href="/static/midi_table/style.css"/>
    <script src="/static/midi_table/redips-drag-min.js" type="text/javascript"></script>
    <script src="/static/midi_table/script.js" type="text/javascript"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>

    <script type='text/javascript' src='http://midijs.net/lib/midi.js'></script>
    <script src="../static/midi_files/inc/shim/Base64.js" type="text/javascript"></script>
	<script src="../static/midi_files/inc/shim/Base64binary.js" type="text/javascript"></script>
	<script src="../static/midi_files/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <script src="../static/midi_files/inc/shim/WebMIDIAPI.js" type="text/javascript"></script>

    <!-- jasmid package -->
	<script src="../static/midi_files/inc/jasmid/stream.js" type="text/javascript"></script>
	<script src="../static/midi_files/inc/jasmid/midifile.js" type="text/javascript"></script>
	<script src="../static/midi_files/inc/jasmid/replayer.js" type="text/javascript"></script>
	<!-- midi.js package -->
	<script src="../static/midi_files/js/midi/audioDetect.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/midi/gm.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/midi/loader.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/midi/plugin.audiotag.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/midi/plugin.webaudio.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <script src="../static/midi_files/js/midi/player.js" type="text/javascript"></script>
    <script src="../static/midi_files/js/midi/synesthesia.js" type="text/javascript"></script>

	<!-- utils -->
	<script src="../static/midi_files/js/util/dom_request_xhr.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/util/dom_request_script.js" type="text/javascript"></script>
    <script src="../static/midi_files/midi_file.js" type="text/javascript"></script>
    <script src="../static/midi_files/JZZ.Midi.js" type="text/javascript"></script>
    <script src="../static/midi_files/JZZ.MidiFile.js" type="text/javascript"></script>

</head>

<script>
data = [];
columns = [];
notes = [];
window.onload = function () {
    data = {{ data|tojson }};
    columns = {{ columns|tojson }};
    var colors = {{ colors|tojson }};
    notes = {{ notes|tojson }};
    var x = new Array(notes.length);
    //initialize Array

    for (var i = 0; i < x.length; i++) {
        x[i] = data[0][notes[i]];
    }
    var result = makeTableHTML(x, colors[0]);
    $('#redips-drag').html(result);

    for(var i = 1; i < data.length; i++) {
        var y = new Array(notes.length);

        for(var j = 0; j < y.length; j++) {
            y[j] = data[i][notes[j]];
        }
        addFile(y, colors[i]);
    }


    MIDI.loadPlugin({
		    soundfontUrl: "../static/midi_files/examples/soundfont/",
		    instrument: "acoustic_grand_piano",
		    onprogress: function(state, progress) {
			    console.log(state, progress);
		    },
		    onsuccess: function(evt) {
                console.log(evt);
            }
    });
};

function playTable() {
    //gets table
    var temp_notes = notes;
    var table = document.getElementById('table');
    var container = new Array(table.rows.item(0).cells.length); //go through table and push notes to container
    //loops through rows - index 1 to skip headers
    for (var i = 0; i < table.rows.item(0).cells.length; i++) {
        container[i] = [];
    }
    for (var i = 0; i < notes.length; i++) {
        var pause = 1;
        for(var j = 0; j < columns.length; j++){
            var whichId = notes[i].toString() + "_" + columns[j].toString();


            var x = document.getElementById(whichId);
            if (x.innerHTML != '') {
                //var key = x.querySelector(".key").innerHTML;
                var key = MIDI.noteToKey[notes[i]];
                var duration = x.querySelector(".duration").innerHTML;
                var volume = x.querySelector(".volume").innerHTML;
                var note = {key: key, duration: duration, volume: volume};
                var n = container[j];
                n.push(note);
                container[j] = n;

            }
        }
    }

    //MIDI.setVolume(0, 100,0);
    container = container.filter(function(n){ return n != '' });

    var noteEvents = [];
    container.forEach(function(note) {
        //ADD: pause
        Array.prototype.push.apply(noteEvents, MidiEvent.createNote(note));
    });
    var track = new MidiTrack({ events: noteEvents });
    var song  = MidiWriter({ tracks: [track] });

    var file = "data:audio/midi;base64," + song.b64;
    notes = temp_notes;
    MIDI.Player.loadFile(file, MIDI.Player.start);
    MIDI.Player.start();

}

function stopPlayer(){
    MIDI.Player.stop();
}

function makeTableHTML(myArray, color) {
    var result = "<table id='table'>";
    result += "<colgroup>";
    for (var i = 0; i < columns.length+1; i++) { //+1 to account for header column!
        var colwidth = (90 / columns.length+1) * (i + 1);
        result += "<col class='col-" + i + "' width='" + colwidth + "'/>"
    }
    result += "</colgroup>";
    result += "<tbody><tr><th></th>";
    for (var i = 0; i < columns.length; i++) {
        result += "<th class = 'table-header'>"+ columns[i]+"</th>";
    }
    result += "</tr>";
    for(var i=0; i<myArray.length; i++) {
        result += "<td class = 'table-header'>" + MIDI.noteToKey[notes[i]] + "</td>";
        for(var j=0; j<columns.length; j++){

            var whichId = notes[i].toString() + "_" + columns[j].toString();
            if(myArray[i][j]== 1) {
                //alert(notes[i]);
                result += "<td id = " + whichId +" onclick='editNote(\"" + whichId + "\");'>" +
                        "<div class='redips-drag' style='border: 2px solid " +color+";'>" +

                        "<div class = 'key'>"+MIDI.noteToKey[notes[i]]+ "</div><div class = 'duration'>"+128+"</div><div class = 'volume'>"+90+"</div>"+
                        "</div>" +
                        "</td>";
            } else {
                result += "<td id = " + whichId +" onclick='editNote(\"" + whichId + "\");'>";
            }
        }
        result += "</tr>";
    }
    result += "</table>";

    return result;
}
function addFile(myArray, color){
    for (var i = 0; i < myArray.length; i++) {
        for (var j = 0; j < myArray[i].length; j++) {
            if(myArray[i][j] == 1) {
                var my_id = notes[i].toString() + "_" + columns[j].toString();
                var div = document.createElement("div");
                div.className = 'redips-drag';
                div.style.cssText = "border: 2px solid " +color+";";
                //div.addEventListener('click', function(){editNote(id)});
                //div.addEventListener("click", editNote, false);

                div.innerHTML = "<div class = 'key'>"+MIDI.noteToKey[notes[i]]+
                                "</div><div class = 'duration'>"+128+
                                "</div><div class = 'volume'>"+90+"</div>";
                document.getElementById(my_id).appendChild(div);
            }
        }
    }
}

function editNote(whichId){

    var form = "<div id = 'form'>";
    form += "Duration: <input type='text' id='form_duration'>";
    form += " Volume: <input type='text' id='form_volume'> ";
   // alert(whichId);
    form += "<button onclick='updateNote(\"" + whichId + "\")'>" + "Submit" + "</button>   ";
    form += "<button onclick='deleteNote(\"" + whichId + "\")'>" + "Delete" + "</button>";
    form += "</div>";

    $('#edit-note').html(form);

}

function updateNote(whichId) {

    var duration = document.getElementById("form_duration").value;
    var volume = document.getElementById("form_volume").value;

    //update note in table
    document.getElementById(whichId).querySelector(".duration").innerHTML = duration;
    document.getElementById(whichId).querySelector(".volume").innerHTML = volume;

}

function saveFile() {
    var filename = prompt("Please enter file name", "file name");

    //save track in container!
     //gets table
    var temp_notes = notes;
    var table = document.getElementById('table');
    var container = new Array(table.rows.item(0).cells.length); //go through table and push notes to container
    //loops through rows - index 1 to skip headers
    for (var i = 0; i < table.rows.item(0).cells.length; i++) {
        container[i] = [];
    }
    for (var i = 0; i < notes.length; i++) {
        //var cells = table.rows.item(i).cells;
        var pause = 1;
        for(var j = 0; j < columns.length; j++){
            var whichId = notes[i].toString() + "_" + columns[j].toString();


            var x = document.getElementById(whichId);
            if (x.innerHTML != '') {
                var key = x.querySelector(".key").innerHTML;
                if (key.length == 2) {
                    key = key[0] + '-' + key[1];
                }
                else if (key.length == 3) {
                    key = key[0] + key[1] + '-' + key[2];
                }
                //var duration = x.querySelector(".duration").innerHTML;
                //var volume = x.querySelector(".volume").innerHTML;
                //var note = {key: key, duration: duration, volume: volume};
                var n = container[j];
                n.push(key);
                container[j] = n;

            }
        }
    }

    $.ajax({
        url: '/edit',
        dataType : "json",
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify({note: container, file: filename}),

        type: 'POST',
        success: function (response) {
            console.log(response);
        },

        error: function (error) {
            console.log(error);
        }
    });


}

// hideAll function
function hideAll() {
	document.getElementById('menu').style.visibility = "hidden";
}
// delete function
function deleteNote(whichId) {
    document.getElementById(whichId).innerHTML = '';
}
</script>

<header>
    <div class="header1">
      <a class="header" id="nav_home" href="{{url_for('homepage')}}">MUSIC COMPOSER</a>
      <br><br>
    </div>
</header>


<body onload="REDIPS.drag.init()">
<div id = "edit-note"></div>
<div id = "redips-drag"> </div>
<div class = "centerButtons">
    <button onclick="playTable()">Play</button>
    <button onclick="stopPlayer()">Stop</button>
    <button onclick="saveFile()">Export</button>
    <button onclick="location.href = '{{url_for('library')}}';">Library</button>

</div>
<br>
<div id="menu" style="visibility:hidden">
            <ul>
                <li id="l1">Delete</li>
            </ul>
   </div>
</body>


</html>