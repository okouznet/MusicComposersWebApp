
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Play</title>
    <link rel="stylesheet" href="../static/playStyles.css"/>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>

    <script type='text/javascript' src='http://midijs.net/lib/midi.js'></script>
    <script src="../static/midi_files/inc/shim/Base64.js" type="text/javascript"></script>
	<script src="../static/midi_files/inc/shim/Base64binary.js" type="text/javascript"></script>
	<script src="../static/midi_files/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <script src="../static/midi_files/inc/shim/WebMIDIAPI.js" type="text/javascript"></script>

    <!-- jasmid package -->
	<script src="../static/midi_files/inc/jasmid/stream.js" type="text/javascript"></script>
	<script src="../static/midi_files/inc/jasmid/midifile.js" type="text/javascript"></script>
	<script src="../static/midi_files/inc/jasmid/replayer.js" type="text/javascript"></script>
	<!-- midi.js package -->
	<script src="../static/midi_files/js/midi/audioDetect.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/midi/gm.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/midi/loader.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/midi/plugin.audiotag.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/midi/plugin.webaudio.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <script src="../static/midi_files/js/midi/player.js" type="text/javascript"></script>
    <script src="../static/midi_files/js/midi/synesthesia.js" type="text/javascript"></script>

	<!-- utils -->
	<script src="../static/midi_files/js/util/dom_request_xhr.js" type="text/javascript"></script>
	<script src="../static/midi_files/js/util/dom_request_script.js" type="text/javascript"></script>
    <script src="../static/midi_files/midi_file.js" type="text/javascript"></script>
    <script src="../static/midi_files/JZZ.Midi.js" type="text/javascript"></script>
    <script src="../static/midi_files/JZZ.MidiFile.js" type="text/javascript"></script>
</head>
<script type="text/javascript">

    octave = 4; //BUG
    var Track = [];
    var record = 0;
    all_notes = ["C","Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];

    id_convert = {90:'C', 83:'Db', 88:'D', 68:'Eb', 67:'E', 86:'F', 71:'Gb',
        66:'G', 72:'Ab', 78:'A', 74:'Bb', 77:'B'};

    window.onload = function () {

        document.getElementById('oct').innerHTML = "Current octave: " + octave;
        //add event listeners for all of the notes
        var theParent = document.querySelector(".piano");
        theParent.addEventListener("mousedown", clickDown, false);
        theParent.addEventListener("mouseup", clickUp, false);
        theParent.addEventListener("touchstart", clickDown, false);
        theParent.addEventListener("touchend", clickUp, false);

	    MIDI.loadPlugin({
		    soundfontUrl: "../static/midi_files/examples/soundfont/",
		    instrument: "acoustic_grand_piano",
		    onprogress: function(state, progress) {
			    console.log(state, progress);
		    },
		    onsuccess: function(evt) {
                console.log(evt);
            }
	    });
    };
   function clickDown(e) {
        if (e.target !== e.currentTarget) {
            var id = e.target.id;
            PlayClickedNote(id);
            document.getElementById(id).style.background = "cornflowerblue";
        }
        e.stopPropagation();
        e.preventDefault();
    }

    function clickUp(e) {
        var id = e.target.id;

        var div = document.getElementById(id);
            var hasClass = div.classList.contains('whitekey');
            if (hasClass == true) {

                document.getElementById(id).style.background = "white";
            }
            else {
                document.getElementById(id).style.background = "black";
            }

    }
    function PlayNote(note) {
        var delay = 0; // play one note every quarter second
        var velocity = 127; // how hard the note hits
        // play the note
        MIDI.setVolume(0, 127);
        MIDI.chordOn(0, note, velocity, delay);
        MIDI.chordOff(0, note, delay + 0.75);
    }

    function PlayTrack() {
        var noteEvents = [];
        var tracks = [];
        Track.forEach(function(note) {
            Array.prototype.push.apply(noteEvents, MidiEvent.createNote(note));
        });
        // Create a track that contains the events to play the notes above
        var track = new MidiTrack({ events: noteEvents });
        tracks.push(track);


        // Creates an object that contains the final MIDI track in base64
        var song  = MidiWriter({ tracks: tracks });

        // Play the song
        var file = "data:audio/midi;base64," + song.b64;
        MIDI.Player.loadFile(file, MIDI.Player.start);
        MIDI.Player.start();
    }

    function SaveTrack() {
        var filename = prompt("Please enter file name", "file name");
        $.ajax({
                 url: '/compose',
                 data: {save: 1, file: filename},
                 type: 'POST',
                 success: function (response) {
                     console.log(response);
                 },

                 error: function (error) {
                     console.log(error);
                 }
        });
    }

    function DiscardTrack() {
        //reset Track
        Track.length = 0;
    }
    function startRecord() {
        record = 1
    }
    function stopRecord() {
        record = 0;
        Track.length = 0;
    }

    function LowOctave() {
        //BUG: sometimes if JS lags, doesn't change octave right away
       if(octave >= 3){
           octave = octave - 1;
       }
       document.getElementById('oct').innerHTML = "Current octave: " + octave;
   }

   function HighOctave() {
       //BUG: sometimes if JS lags, doesn't change octave right away
       if(octave <= 6){
           octave = octave +1;
       }
       document.getElementById('oct').innerHTML = "Current octave: " + octave;
   }

    var keys = {};
    var start = 0;
    var end = 0;

    function PlayClickedNote(key) {
        start = +new Date();
        //90:"C-4"
        o = octave; //BUG: OCTAVE
            var map = { 'C':12*o, 'Db':12*o+1, 'D':12*o+2, 'Eb':12*o+3, 'E':12*o+4, 'F':12*o+5, 'Gb':12*o+6,
                'G':12*o+7, 'Ab':12*o+8, 'A':12*o+9, 'Bb':12*o+10, 'B':12*o+11 };
        //save notes
        end = +new Date();
         if(record == 1) {
            var temp = [];
            var mingus = [];
            var n = {key: key + (octave-1).toString(), duration: end - start, volume: 90};
            // alert(key+octave.toString());
            temp.push(n);
            mingus.push(map[key]); //BUG - check how file is saved!
            //handle empty array
            if(temp.length > 0) {
                if (Track.length == 0){
                    Track.push(temp);
                }
                Track.push(temp);
            }
            $.ajax({
                 url: '/compose',
                 data: {note: mingus, save: 0},
                 type: 'POST',
                 success: function (response) {
                     console.log(response);
                 },
                 error: function (error) {
                     console.log(error);
                 }
            });

        }
        start = 0;
        end = 0;

        //play notes
        var notes = [];
        var x = map[key];
        notes.push(x);
        PlayNote(notes);
    }

    document.onkeydown = function (event) {
        start = +new Date();

        var note_map = { 90:12*octave, 83:12*octave+1, 88:12*octave+2, 68:12*octave+3, 67:12*octave+4,
            86:12*octave+5, 71:12*octave+6, 66:12*octave+7, 72:12*octave+8, 78:12*octave+9,
            74:12*octave+10, 77:12*octave+11 };

        keys[event.which] = true;

        if (87 in keys) {
            LowOctave();
            delete keys[87];
        }
        else if (82 in keys) {
            HighOctave();
            delete keys[82];
        }
        else {
            var notes = [];
            for (var i in keys) {
            notes.push(note_map[i]);
            if(id_convert[i] != null) {
                document.getElementById(id_convert[i]).style.background = "cornflowerblue";
            }
            }
            PlayNote(notes);
        }
    };

    document.onkeyup = function(event) {
        end = +new Date();
        var note_map = { 90:12*octave, 83:12*octave+1, 88:12*octave+2, 68:12*octave+3, 67:12*octave+4,
            86:12*octave+5, 71:12*octave+6, 66:12*octave+7, 72:12*octave+8, 78:12*octave+9,
            74:12*octave+10, 77:12*octave+11 };

        for (var i in keys) {
          if(id_convert[i] != null) {
              var div = document.getElementById(id_convert[i]);
              var hasClass = div.classList.contains('whitekey');
              if (hasClass == true) {
                  document.getElementById(id_convert[i]).style.background = "white";
              }
              else {
                  document.getElementById(id_convert[i]).style.background = "black";
              }
          }
        }

        if(record == 1) {
            var temp = [];
            var mingus = [];
            for (var i in keys) {
                var n = {key: MIDI.noteToKey[note_map[i]], duration: end - start, volume: 90};
                temp.push(n);
                mingus.push(note_map[i]);
                delete keys[i];
            }
            //handle empty array
            if(temp.length > 0) {
                if (Track.length == 0) {
                    Track.push(temp)
                }
                Track.push(temp);
            }
            $.ajax({
                 url: '/compose',
                 data: {note: mingus, save: 0},
                 type: 'POST',
                 success: function (response) {
                     console.log(response);
                 },
                 error: function (error) {
                     console.log(error);
                 }
            });

        }
        else {
            delete keys[event.which];
        }
        start = 0;
        end = 0;
    }

</script>
<header>
    <div class="header1">
      <a class="header" id="nav_home" href="{{url_for('homepage')}}">MUSIC COMPOSER</a>
    </div>
    <br><br>
</header>
<body>
    <p id="oct">Current octave: 4</p>
    <div class = "centerButtons">
         <button onclick="LowOctave()">Lower Octave (w)</button>
         <button onclick="HighOctave()">Higher Octave (r)</button>
    </div>
    <div class = piano>
    <ul>
        <li class = "key">
            <span class="whitekey" id = "C">Z</span>
            <span class="blackkey" id = "Db">S</span>
        </li>
        <li class = "key">
            <span class="whitekey" id = "D">X</span>
            <span class="blackkey" id = "Eb">D</span>
        </li>
        <li class = "key">
            <span class="whitekey" id = "E">C</span>
        </li>
        <li class = "key">
            <span class="whitekey" id = "F">V</span>
            <span class="blackkey" id = "Gb">G</span>
        </li>
        <li class = "key">
            <span class="whitekey" id = "G">B</span>
            <span class="blackkey" id = "Ab">H</span>
        </li>
        <li class = "key">
            <span class="whitekey" id = "A">N</span>
            <span class="blackkey" id = "Bb">J</span>
        </li>
        <li class = "key">
            <span class="whitekey" id = "B">M</span>
        </li>

    </ul>
        <br>
    </div>
    <div class = "centerButtons">
        <button onclick="startRecord()">Start Record</button>
        <button onclick="stopRecord()">Stop Record</button>
        <button onclick="PlayTrack()">Playback</button>
        <button onclick="DiscardTrack()">Discard</button>
        <button onclick="SaveTrack()">Save</button>

        <button onclick="location.href = '{{url_for('library')}}';">Library</button>
    </div>

</body>

</html>